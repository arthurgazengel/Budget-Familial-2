<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Budget Familial</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    if (localStorage.getItem('theme') === 'dark' || (
      !localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    }
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service worker enregistr√©'))
          .catch(err => console.error('Erreur SW', err));
      });
    }
  </script>
  <style>
    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background-color: #4ade80;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 9999;
      display: none;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-white">
  <div class="max-w-5xl mx-auto p-4">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-center w-full">Budget Familial</h1>
      <button onclick="toggleTheme()" class="ml-auto bg-gray-300 dark:bg-gray-700 text-sm text-gray-800 dark:text-white px-3 py-1 rounded shadow">
        üåô / ‚òÄÔ∏è
      </button>
    </div>

    <!-- Notification toast -->
    <div id="toast" class="toast"></div>

    <!-- Ajouter une cat√©gorie personnalis√©e -->
    <div class="mb-6">
      <label for="newCategory" class="block text-sm font-medium mb-1">Ajouter une nouvelle cat√©gorie</label>
      <div class="flex items-center gap-2">
        <input id="newCategory" type="text" class="border p-2 rounded w-full" placeholder="Nouvelle cat√©gorie">
        <button onclick="addCategory()" class="bg-blue-600 text-white px-3 py-1 rounded">Ajouter</button>
      </div>
    </div>

    <!-- Statistiques suppl√©mentaires -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Total D√©penses</h2>
        <p id="monthExpenses" class="text-red-500 text-2xl font-bold">‚Ç¨0.00</p>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Moyenne / mois</h2>
        <p id="averageExpenses" class="text-yellow-500 text-2xl font-bold">‚Ç¨0.00</p>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Plus grosse d√©pense</h2>
        <p id="maxExpense" class="text-orange-500 text-2xl font-bold">‚Ç¨0.00</p>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Cat√©gorie N¬∞1</h2>
        <p id="topCategory" class="text-green-500 text-2xl font-bold">-</p>
      </div>
    </div>

    <!-- Historique des d√©penses avec √©dition/suppression -->
    <div id="expenseHistory" class="space-y-2"></div>
  </div>

  <script>
    function toggleTheme() {
      if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    function addCategory() {
      const input = document.getElementById('newCategory');
      const category = input.value.trim();
      if (category) {
        const select = document.getElementById('category');
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
        input.value = '';
        showToast(`Cat√©gorie "${category}" ajout√©e`);
      }
    }

    function updateStats(data) {
      const monthlyTotals = {};
      let max = 0;
      let topCat = '';
      const catTotals = {};

      data.forEach(d => {
        const month = d.date?.slice(0, 7);
        if (month) {
          if (!monthlyTotals[month]) monthlyTotals[month] = 0;
          monthlyTotals[month] += parseFloat(d.montant || 0);
        }
        const amount = parseFloat(d.montant || 0);
        if (amount > max) max = amount;
        const cat = d.categorie;
        if (!catTotals[cat]) catTotals[cat] = 0;
        catTotals[cat] += amount;
      });

      const total = Object.values(monthlyTotals).reduce((a, b) => a + b, 0);
      const average = total / Object.keys(monthlyTotals).length;
      const top = Object.entries(catTotals).sort((a, b) => b[1] - a[1])[0]?.[0] || '-';

      document.getElementById('averageExpenses').textContent = `‚Ç¨${average.toFixed(2)}`;
      document.getElementById('maxExpense').textContent = `‚Ç¨${max.toFixed(2)}`;
      document.getElementById('topCategory').textContent = top;
    }

    function updateUI(data) {
      updateStats(data);
    }
  </script>
</body>
</html>
